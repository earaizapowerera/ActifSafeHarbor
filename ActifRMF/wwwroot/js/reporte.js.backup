// Reporte Safe Harbor JavaScript con AG-Grid
// Dos grids separados: Extranjeros y Nacionales

let gridApiExtranjeros;
let gridApiNacionales;
let currentDataExtranjeros = [];
let currentDataNacionales = [];

document.addEventListener('DOMContentLoaded', function() {
    cargarCompanias();
    inicializarAños();
    inicializarGrids();

    document.getElementById('btnCargarReporte').addEventListener('click', cargarReporte);
    document.getElementById('btnExportarExcel').addEventListener('click', exportarExcel);
});

function inicializarAños() {
    const añoSelect = document.getElementById('añoSelect');
    const añoActual = new Date().getFullYear();

    añoSelect.innerHTML = '<option value="">Seleccionar...</option>';
    for (let año = añoActual; año >= añoActual - 10; año--) {
        añoSelect.innerHTML += `<option value="${año}">${año}</option>`;
    }
}

async function cargarCompanias() {
    try {
        const response = await fetch(`/api/companias?v=${Date.now()}`);
        if (!response.ok) throw new Error('Error al cargar compañías');

        const companias = await response.json();
        const select = document.getElementById('companiaSelect');

        select.innerHTML = '<option value="">Seleccionar...</option>';
        companias.forEach(c => {
            select.innerHTML += `<option value="${c.idCompania}">${c.nombreCompania}</option>`;
        });
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar las compañías');
    }
}

function inicializarGrids() {
    inicializarGridExtranjeros();
    inicializarGridNacionales();
}

function inicializarGridExtranjeros() {
    const columnDefs = [
        {
            headerName: 'Placa',
            field: 'placa',
            filter: 'agTextColumnFilter',
            width: 150,
            pinned: 'left'
        },
        {
            headerName: 'Descripción',
            field: 'descripcion',
            filter: 'agTextColumnFilter',
            width: 300
        },
        {
            headerName: 'Tipo',
            field: 'tipo',
            filter: 'agTextColumnFilter',
            width: 180
        },
        {
            headerName: 'Fecha Adquisición',
            field: 'fecha_Adquisicion',
            filter: 'agDateColumnFilter',
            width: 150,
            valueFormatter: params => {
                if (!params.value) return '';
                const date = new Date(params.value);
                return date.toLocaleDateString('es-MX');
            }
        },
        {
            headerName: 'Fecha Baja',
            field: 'fecha_Baja',
            filter: 'agDateColumnFilter',
            width: 130,
            valueFormatter: params => {
                if (!params.value) return '';
                const date = new Date(params.value);
                return date.toLocaleDateString('es-MX');
            }
        },
        {
            headerName: 'MOI',
            field: 'moi',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Anual Rate',
            field: 'anual_Rate',
            filter: 'agNumberColumnFilter',
            width: 120,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(4) : ''
        },
        {
            headerName: 'Month Rate',
            field: 'month_Rate',
            filter: 'agNumberColumnFilter',
            width: 120,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : ''
        },
        {
            headerName: 'Deprec Anual',
            field: 'deprec_Anual',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Meses Uso Inicio Ejerc.',
            field: 'meses_Uso_Inicio_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn'
        },
        {
            headerName: 'Meses Uso Hasta Mitad',
            field: 'meses_Uso_Hasta_Mitad_Periodo',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn'
        },
        {
            headerName: 'Meses Uso En Ejercicio',
            field: 'meses_Uso_En_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn'
        },
        {
            headerName: 'Dep Fiscal Acum. Inicio Año',
            field: 'dep_Fiscal_Acumulada_Inicio_Año',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Saldo Por Deducir ISR Inicio',
            field: 'saldo_Por_Deducir_ISR_Al_Inicio_Año',
            filter: 'agNumberColumnFilter',
            width: 200,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Dep Fiscal Ejercicio',
            field: 'dep_Fiscal_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Monto Pendiente',
            field: 'monto_Pendiente',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Proporción',
            field: 'proporcion',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Prueba 10% MOI',
            field: 'prueba_10_Pct_MOI',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Tipo Cambio 30 Junio',
            field: 'tipo_Cambio_30_Junio',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : ''
        },
        {
            headerName: 'Valor Reportable MXN',
            field: 'valor_Reportable_MXN',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? '$' + params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'font-weight': 'bold', 'color': '#0d6efd'}
        },
        {
            headerName: 'Observaciones',
            field: 'observaciones',
            filter: 'agTextColumnFilter',
            width: 400
        }
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
            sortable: true,
            resizable: true,
            filter: true,
            floatingFilter: true
        },
        pagination: true,
        paginationPageSize: 50,
        paginationPageSizeSelector: [20, 50, 100, 200],
        rowSelection: 'multiple',
        enableRangeSelection: true,
        suppressRowClickSelection: true,
        animateRows: true,
        overlayNoRowsTemplate: '<span style="padding: 20px; font-size: 16px; color: #666;">No hay activos extranjeros para mostrar</span>',
        onGridReady: function(params) {
            gridApiExtranjeros = params.api;
        }
    };

    const gridDiv = document.querySelector('#gridExtranjeros');
    agGrid.createGrid(gridDiv, gridOptions);
}

function inicializarGridNacionales() {
    const columnDefs = [
        {
            headerName: 'Placa',
            field: 'placa',
            filter: 'agTextColumnFilter',
            width: 150,
            pinned: 'left'
        },
        {
            headerName: 'Descripción',
            field: 'descripcion',
            filter: 'agTextColumnFilter',
            width: 300
        },
        {
            headerName: 'Tipo',
            field: 'tipo',
            filter: 'agTextColumnFilter',
            width: 180
        },
        {
            headerName: 'Fecha Adquisición',
            field: 'fecha_Adquisicion',
            filter: 'agDateColumnFilter',
            width: 150,
            valueFormatter: params => {
                if (!params.value) return '';
                const date = new Date(params.value);
                return date.toLocaleDateString('es-MX');
            }
        },
        {
            headerName: 'Fecha Baja',
            field: 'fecha_Baja',
            filter: 'agDateColumnFilter',
            width: 130,
            valueFormatter: params => {
                if (!params.value) return '';
                const date = new Date(params.value);
                return date.toLocaleDateString('es-MX');
            }
        },
        {
            headerName: 'MOI',
            field: 'moi',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Anual Rate',
            field: 'anual_Rate',
            filter: 'agNumberColumnFilter',
            width: 120,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(4) : ''
        },
        {
            headerName: 'Month Rate',
            field: 'month_Rate',
            filter: 'agNumberColumnFilter',
            width: 120,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : ''
        },
        {
            headerName: 'Deprec Anual',
            field: 'deprec_Anual',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Meses Uso Al Ejerc. Anterior',
            field: 'meses_Uso_Al_Ejercicio_Anterior',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn'
        },
        {
            headerName: 'Meses Uso En Ejercicio',
            field: 'meses_Uso_En_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn'
        },
        {
            headerName: 'Dep Fiscal Acum. Inicio Año',
            field: 'dep_Fiscal_Acumulada_Inicio_Año',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        {
            headerName: 'Saldo Por Deducir ISR Inicio',
            field: 'saldo_Por_Deducir_ISR_Al_Inicio_Año',
            filter: 'agNumberColumnFilter',
            width: 200,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
        },
        // PASO 1: INPC Actualización
        {
            headerName: 'INPC Adquisición',
            field: 'inpc_Adquisicion',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : '',
            cellStyle: {'background-color': '#e7f3ff'}
        },
        {
            headerName: 'INPC Mitad Ejercicio',
            field: 'inpc_Mitad_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : '',
            cellStyle: {'background-color': '#e7f3ff'}
        },
        {
            headerName: 'Factor Actualiz. (P1)',
            field: 'factor_Actualizacion_Paso1',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(4) : '',
            cellStyle: {'background-color': '#e7f3ff', 'font-weight': 'bold'}
        },
        {
            headerName: 'Saldo Actualizado (P1)',
            field: 'saldo_Actualizado_Paso1',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#e7f3ff', 'font-weight': 'bold'}
        },
        // PASO 2: Depreciación Actualizada
        {
            headerName: 'Dep Fiscal Ejercicio',
            field: 'dep_Fiscal_Ejercicio',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#fff3cd'}
        },
        {
            headerName: 'INPC Adquisición (P2)',
            field: 'inpc_Adqu_Paso2',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : '',
            cellStyle: {'background-color': '#fff3cd'}
        },
        {
            headerName: 'INPC Mitad Periodo',
            field: 'inpc_Mitad_Periodo',
            filter: 'agNumberColumnFilter',
            width: 150,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(6) : '',
            cellStyle: {'background-color': '#fff3cd'}
        },
        {
            headerName: 'Factor Actualiz. (P2)',
            field: 'factor_Actualizacion_Paso2',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toFixed(4) : '',
            cellStyle: {'background-color': '#fff3cd', 'font-weight': 'bold'}
        },
        {
            headerName: 'Deprec Fiscal Actualizada',
            field: 'depreciacion_Fiscal_Actualizada',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#fff3cd', 'font-weight': 'bold'}
        },
        {
            headerName: '50% Deprec Fiscal',
            field: 'mitad_Depreciacion_Fiscal',
            filter: 'agNumberColumnFilter',
            width: 160,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#fff3cd', 'font-weight': 'bold'}
        },
        // PASO 3: Valor Safe Harbor
        {
            headerName: 'Valor Promedio',
            field: 'valor_Promedio',
            filter: 'agNumberColumnFilter',
            width: 140,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#d1e7dd'}
        },
        {
            headerName: 'Valor Prom. Prop. Año',
            field: 'valor_Promedio_Proporcional_Año',
            filter: 'agNumberColumnFilter',
            width: 170,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#d1e7dd', 'font-weight': 'bold', 'color': '#0d6efd'}
        },
        {
            headerName: 'Saldo Fiscal Deducir Hist.',
            field: 'saldo_Fiscal_Por_Deducir_Historico',
            filter: 'agNumberColumnFilter',
            width: 180,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#d1e7dd'}
        },
        {
            headerName: 'Saldo Fiscal Deducir Actual.',
            field: 'saldo_Fiscal_Por_Deducir_Actualizado',
            filter: 'agNumberColumnFilter',
            width: 190,
            type: 'numericColumn',
            valueFormatter: params => params.value ? params.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
            cellStyle: {'background-color': '#d1e7dd'}
        },
        {
            headerName: 'Estado (B/A)',
            field: 'estado_Activo_Baja',
            filter: 'agTextColumnFilter',
            width: 120,
            cellStyle: params => {
                if (params.value === 'B') {
                    return {'background-color': '#f8d7da', 'font-weight': 'bold'};
                }
                return {'background-color': '#d1e7dd'};
            }
        },
        {
            headerName: 'Observaciones',
            field: 'observaciones',
            filter: 'agTextColumnFilter',
            width: 400
        }
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
            sortable: true,
            resizable: true,
            filter: true,
            floatingFilter: true
        },
        pagination: true,
        paginationPageSize: 50,
        paginationPageSizeSelector: [20, 50, 100, 200],
        rowSelection: 'multiple',
        enableRangeSelection: true,
        suppressRowClickSelection: true,
        animateRows: true,
        overlayNoRowsTemplate: '<span style="padding: 20px; font-size: 16px; color: #666;">No hay activos nacionales para mostrar</span>',
        onGridReady: function(params) {
            gridApiNacionales = params.api;
        }
    };

    const gridDiv = document.querySelector('#gridNacionales');
    agGrid.createGrid(gridDiv, gridOptions);
}

async function cargarReporte() {
    const idCompania = document.getElementById('companiaSelect').value;
    const añoCalculo = document.getElementById('añoSelect').value;

    if (!idCompania || !añoCalculo) {
        alert('Por favor seleccione compañía y año');
        return;
    }

    try {
        const btnCargar = document.getElementById('btnCargarReporte');
        btnCargar.disabled = true;
        btnCargar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

        // Cache-busting con timestamp
        const response = await fetch(`/api/reporte/${idCompania}/${añoCalculo}?v=${Date.now()}`);
        if (!response.ok) throw new Error('Error al cargar reporte');

        const data = await response.json();

        // El backend ahora devuelve: { extranjeros: [], nacionales: [], totales: {} }
        currentDataExtranjeros = data.extranjeros || [];
        currentDataNacionales = data.nacionales || [];

        // Cargar datos en los grids
        gridApiExtranjeros.setGridOption('rowData', currentDataExtranjeros);
        gridApiNacionales.setGridOption('rowData', currentDataNacionales);

        // Mostrar overlays si no hay datos
        if (currentDataExtranjeros.length === 0) {
            gridApiExtranjeros.showNoRowsOverlay();
        }
        if (currentDataNacionales.length === 0) {
            gridApiNacionales.showNoRowsOverlay();
        }

        // Calcular totales combinados
        const totalRegistros = currentDataExtranjeros.length + currentDataNacionales.length;
        document.getElementById('contadorRegistros').textContent = `${totalRegistros} registros (${currentDataExtranjeros.length} extranjeros, ${currentDataNacionales.length} nacionales)`;
        document.getElementById('btnExportarExcel').disabled = totalRegistros === 0;

        // Calcular y mostrar totales
        if (totalRegistros > 0) {
            // MOI: suma de ambos arrays
            const totalMOI_Ext = currentDataExtranjeros.reduce((sum, row) => sum + (row.moi || 0), 0);
            const totalMOI_Nac = currentDataNacionales.reduce((sum, row) => sum + (row.moi || 0), 0);
            const totalMOI = totalMOI_Ext + totalMOI_Nac;

            // Valor Reportable: extranjeros usan Valor_Reportable_MXN, nacionales usan Valor_Promedio_Proporcional_Año
            const totalValor_Ext = currentDataExtranjeros.reduce((sum, row) => sum + (row.valor_Reportable_MXN || 0), 0);
            const totalValor_Nac = currentDataNacionales.reduce((sum, row) => sum + (row.valor_Promedio_Proporcional_Año || 0), 0);
            const totalValor = totalValor_Ext + totalValor_Nac;

            // Activos con 10% MOI: solo extranjeros tienen esta prueba
            const totalActivos10Pct = currentDataExtranjeros.filter(row => (row.prueba_10_Pct_MOI || 0) > 0).length;

            // Actualizar tarjeta de totales
            document.getElementById('totalRegistros').textContent = totalRegistros.toLocaleString('en-US');
            document.getElementById('totalMOI').textContent = '$' + totalMOI.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalActivos10Pct').textContent = totalActivos10Pct.toLocaleString('en-US');
            document.getElementById('totalValorReportable').textContent = '$' + totalValor.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Mostrar contenedor de totales
            document.getElementById('totalesContainer').style.display = 'block';

            // Mensaje de éxito
            console.log('Reporte cargado exitosamente:', {
                totalExtranjeros: currentDataExtranjeros.length,
                totalNacionales: currentDataNacionales.length,
                totalMOI: totalMOI,
                activosCon10Pct: totalActivos10Pct,
                valorTotalReportable: totalValor
            });
        } else {
            document.getElementById('totalesContainer').style.display = 'none';
        }

        btnCargar.disabled = false;
        btnCargar.innerHTML = '<i class="fas fa-search"></i> Cargar Reporte';

    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el reporte: ' + error.message);

        const btnCargar = document.getElementById('btnCargarReporte');
        btnCargar.disabled = false;
        btnCargar.innerHTML = '<i class="fas fa-search"></i> Cargar Reporte';
    }
}

function exportarExcel() {
    const totalRegistros = currentDataExtranjeros.length + currentDataNacionales.length;

    if (totalRegistros === 0) {
        alert('No hay datos para exportar');
        return;
    }

    const companiaText = document.getElementById('companiaSelect').selectedOptions[0].text;
    const año = document.getElementById('añoSelect').value;
    const fecha = new Date().toISOString().split('T')[0];

    // Exportar Extranjeros
    if (currentDataExtranjeros.length > 0) {
        const paramsExt = {
            fileName: `SafeHarbor_Extranjeros_${companiaText.replace(/\s+/g, '_')}_${año}_${fecha}.csv`,
            sheetName: `Extranjeros ${año}`
        };
        gridApiExtranjeros.exportDataAsCsv(paramsExt);
        console.log(`Exportados ${currentDataExtranjeros.length} activos extranjeros`);
    }

    // Exportar Nacionales
    if (currentDataNacionales.length > 0) {
        const paramsNac = {
            fileName: `SafeHarbor_Nacionales_${companiaText.replace(/\s+/g, '_')}_${año}_${fecha}.csv`,
            sheetName: `Nacionales ${año}`
        };
        gridApiNacionales.exportDataAsCsv(paramsNac);
        console.log(`Exportados ${currentDataNacionales.length} activos nacionales`);
    }

    alert(`Exportación completada:\n- ${currentDataExtranjeros.length} activos extranjeros\n- ${currentDataNacionales.length} activos nacionales`);
}
